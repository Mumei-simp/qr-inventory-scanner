<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart QR Inventory</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { font-family: system-ui, sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        #reader { width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .card { background: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 12px; margin-top: 20px; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        .status-pill { display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; margin-bottom: 10px; }
        .syncing { background: #fef9c3; color: #854d0e; }
        .ready { background: #dcfce7; color: #166534; }
        input[type="text"] { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .switch-box { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 0.9rem; color: #475569; }
    </style>
</head>
<body>

    <div id="reader"></div>

    <div class="card">
        <div id="status" class="status-pill syncing">Initializing...</div>
        
        <div class="switch-box">
            <input type="checkbox" id="cont-scan">
            <label for="cont-scan">Continuous Scan (Auto-Push)</label>
        </div>

        <div id="manual-form" style="display: none;">
            <p style="margin: 0; font-size: 0.8rem; color: #64748b;">Detected Serial:</p>
            <strong id="display-serial">---</strong>
            <input type="text" id="item-name" placeholder="Item Name (Optional)">
            <button onclick="manualPush()">Push to Sheet</button>
        </div>
    </div>

    <script>
        // REPLACE WITH YOUR URL
        const scriptURL = "https://script.google.com/macros/s/YOUR_URL_HERE/exec";
        
        let cache = new Set();
        let isLock = false;

        const statusEl = document.getElementById('status');
        const contSwitch = document.getElementById('cont-scan');
        const manualForm = document.getElementById('manual-form');
        const serialTxt = document.getElementById('display-serial');
        const nameInput = document.getElementById('item-name');

        // 1. Fetch Cache
        async function loadCache() {
            try {
                const res = await fetch(`${scriptURL}?action=fetch`);
                const data = await res.json();
                data.serials.forEach(s => cache.add(String(s)));
                statusEl.innerText = `Ready: ${cache.size} items cached`;
                statusEl.className = "status-pill ready";
            } catch (e) {
                statusEl.innerText = "Sync Failed";
                console.error(e);
            }
        }

        // 2. Scan Trigger
        function onScanSuccess(decodedText) {
            if (isLock) return;
            if (cache.has(decodedText)) {
                statusEl.innerText = `Duplicate: ${decodedText}`;
                return;
            }

            if (contSwitch.checked) {
                autoPush(decodedText);
            } else {
                showManual(decodedText);
            }
        }

        // 3. Auto Mode
        async function autoPush(serial) {
            isLock = true;
            statusEl.innerText = `Auto-Pushing: ${serial}...`;
            await sendData("", serial);
            setTimeout(() => { isLock = false; }, 2000); // 2 sec cooldown
        }

        // 4. Manual Mode
        function showManual(serial) {
            isLock = true; // Stop scanner from overwriting current find
            serialTxt.innerText = serial;
            manualForm.style.display = "block";
        }

        async function manualPush() {
            const serial = serialTxt.innerText;
            const name = nameInput.value;
            statusEl.innerText = "Pushing...";
            await sendData(name, serial);
            
            // Reset
            manualForm.style.display = "none";
            nameInput.value = "";
            isLock = false;
        }

        // 5. Unified Sender
        async function sendData(name, serial) {
            const query = `?action=push&name=${encodeURIComponent(name)}&serial=${encodeURIComponent(serial)}`;
            try {
                const res = await fetch(scriptURL + query);
                const result = await res.json();
                if (result.status === "success") {
                    cache.add(serial);
                    statusEl.innerText = `Success! Added ${serial}`;
                }
            } catch (e) {
                statusEl.innerText = "Error Pushing Data";
            }
        }

        const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render(onScanSuccess);
        loadCache();
    </script>
</body>
</html>

