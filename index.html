<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rescue Inventory Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { font-family: system-ui, sans-serif; background: var(--bg); padding: 10px; display: flex; flex-direction: column; align-items: center; margin: 0; }
        
        #reader-wrapper { 
            position: relative; width: 100%; max-width: 600px; height: 350px; 
            border-radius: 12px; overflow: hidden; background: #000; 
            border: 3px solid #cbd5e1;
        }
        #reader { width: 100%; height: 100%; }
        
        .laser {
            position: absolute; top: 50%; left: 5%; width: 90%; height: 2px;
            background: red; box-shadow: 0 0 8px red; z-index: 10; pointer-events: none;
        }

        .card { background: white; width: 100%; max-width: 600px; padding: 20px; border-radius: 15px; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); box-sizing: border-box; }
        .status-pill { display: inline-block; padding: 8px 16px; border-radius: 9999px; font-size: 0.9rem; font-weight: 700; margin-bottom: 15px; }
        .ready { background: #dcfce7; color: #166534; }
        .error { background: #fee2e2; color: #991b1b; }
        
        select { width: 100%; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
        #zoom-container { background: #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

    <div id="reader-wrapper">
        <div id="reader"></div>
        <div class="laser"></div>
    </div>

    <div class="card">
        <div id="status" class="status-pill ready">Syncing...</div>
        
        <select id="cam-list" onchange="switchCamera(this.value)"></select>
        
        <div id="zoom-container" style="display:none;">
            <label style="font-size: 0.8rem;">Zoom Control:</label>
            <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1" oninput="applyZoom(this.value)">
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="checkbox" id="cont-scan"> <label for="cont-scan">Auto-Push</label>
        </div>

        <div id="manual-form" style="display: none; border-top: 1px solid #eee; padding-top:10px;">
            <p style="font-size: 0.8rem; color: #666; margin:0;">Serial Detected:</p>
            <strong id="display-serial" style="font-size: 1.2rem; color: var(--primary);">---</strong>
            <input type="text" id="item-name" placeholder="Item Name (Optional)" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ccc; border-radius:8px;">
            <button onclick="manualPush()">Push to Sheet</button>
        </div>
        
        <button id="torch-btn" style="display:none; margin-top:10px; background:#475569;" onclick="toggleTorch()">Toggle Flashlight</button>
    </div>

    <script>
        // REPLACE WITH YOUR URL
        const scriptURL = "https://script.google.com/macros/s/AKfycbzNSy4eQ5Tm3ZR429ozDAp7MekYHzQu5qEmLAFgYpqtUaxHGAIjMcEG5a4R9vqrrhKn/exec";
        
        let html5QrCode;
        let cache = new Set();
        let isLock = false;
        let isTorchOn = false;

        async function init() {
            try {
                const cameras = await Html5Qrcode.getCameras();
                if (cameras && cameras.length) {
                    const camList = document.getElementById('cam-list');
                    // Check labels for "back" to help find the right lens
                    cameras.forEach((camera, index) => {
                        const option = document.createElement('option');
                        option.value = camera.id;
                        option.text = camera.label || `Camera ${index + 1}`;
                        camList.appendChild(option);
                    });
                    // Pick the last camera (often the main back camera)
                    startScanner(cameras[cameras.length - 1].id);
                }
            } catch (err) { document.getElementById('status').innerText = "Permission Denied"; }
            loadCache();
        }

        async function startScanner(cameraId) {
            if (html5QrCode) { 
                try { await html5QrCode.stop(); } catch (e) {} 
            }
            
            html5QrCode = new Html5Qrcode("reader");

            const config = { 
                fps: 20, 
                qrbox: { width: 300, height: 200 }, // Scaled down slightly to prevent lag
                aspectRatio: 1.0,
                // Using standard constraints to prevent the "108MP noise" crash
                videoConstraints: { 
                    deviceId: { exact: cameraId },
                    facingMode: "environment"
                }
            };

            try {
                await html5QrCode.start(cameraId, config, onScanSuccess);
                checkCapabilities();
            } catch (err) { 
                console.error(err);
                // Fail-safe: Try without exact device ID if it fails
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
            }
        }

        function onScanSuccess(decodedText) {
            if (isLock) return;
            if (cache.has(decodedText)) return;

            const display = document.getElementById('display-serial');
            if (document.getElementById('cont-scan').checked) {
                autoPush(decodedText);
            } else if (decodedText !== display.innerText) {
                display.innerText = decodedText;
                document.getElementById('manual-form').style.display = "block";
                if (navigator.vibrate) navigator.vibrate(50);
            }
        }

        // --- Helper Functions ---
        async function checkCapabilities() {
            const track = html5QrCode.getRunningTrack();
            const caps = track.getCapabilities();
            if (caps.torch) document.getElementById('torch-btn').style.display = "block";
            if (caps.zoom) {
                const s = document.getElementById('zoom-slider');
                s.min = caps.zoom.min; s.max = caps.zoom.max; s.step = caps.zoom.step;
                document.getElementById('zoom-container').style.display = "block";
            }
        }

        function applyZoom(val) { html5QrCode.getRunningTrack().applyConstraints({advanced: [{zoom: val}]}); }
        function switchCamera(val) { startScanner(val); }
        async function toggleTorch() { 
            isTorchOn = !isTorchOn; 
            await html5QrCode.applyVideoConstraints({advanced: [{torch: isTorchOn}]}); 
        }

        async function loadCache() {
            try {
                const res = await fetch(`${scriptURL}?action=fetch`);
                const data = await res.json();
                data.serials.forEach(s => cache.add(String(s)));
                document.getElementById('status').innerText = `Ready: ${cache.size} Items`;
            } catch (e) { document.getElementById('status').innerText = "Offline Mode"; }
        }

        async function sendData(name, serial) {
            isLock = true;
            try {
                const res = await fetch(`${scriptURL}?action=push&name=${encodeURIComponent(name)}&serial=${encodeURIComponent(serial)}`);
                const result = await res.json();
                if (result.status === "success") {
                    cache.add(serial);
                    document.getElementById('status').innerText = "Added Successfully!";
                }
            } catch (e) { alert("Push Failed"); }
            isLock = false;
        }

        async function autoPush(serial) {
            await sendData("", serial);
            setTimeout(() => { isLock = false; }, 2000);
        }

        async function manualPush() {
            const name = document.getElementById('item-name').value;
            const serial = document.getElementById('display-serial').innerText;
            await sendData(name, serial);
            document.getElementById('manual-form').style.display = "none";
            document.getElementById('display-serial').innerText = "---";
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
